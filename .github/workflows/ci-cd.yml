name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'config/**'
      - 'Makefile'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
      - 'cmd/**'
      - 'internal/**'
      - 'api/**'
      - 'charts/**'
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version_bump_type:
        description: 'Version bump type for major releases'
        required: true
        default: 'major'
        type: choice
        options:
          - major
          - minor
          - patch
      force_bump:
        description: 'Force version bump even if tag exists'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  REGISTRY: fatiudeen
  IMAGE_NAME: dbchan

jobs:

  version-management:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      chart-version: ${{ steps.version-bump.outputs.chart-version }}
      app-version: ${{ steps.version-bump.outputs.app-version }}
      image-tag: ${{ steps.version-bump.outputs.image-tag }}
      should-bump: ${{ steps.version-bump.outputs.should-bump }}
      new-tag: ${{ steps.version-bump.outputs.new-tag }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for tag checking
    
    - name: Set up Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Version Management
      id: version-bump
      run: |
        # Get current versions from Chart.yaml
        CHART_VERSION=$(grep '^version:' charts/dbchan/Chart.yaml | awk '{print $2}')
        APP_VERSION=$(grep '^appVersion:' charts/dbchan/Chart.yaml | awk '{print $2}' | tr -d '"')
        
        echo "Current chart version: $CHART_VERSION"
        echo "Current app version: $APP_VERSION"
        
        # Determine if we should bump version
        SHOULD_BUMP="false"
        NEW_TAG=""
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Manual workflow dispatch - always bump
          BUMP_TYPE="${{ github.event.inputs.version_bump_type }}"
          FORCE_BUMP="${{ github.event.inputs.force_bump }}"
          SHOULD_BUMP="true"
          echo "Manual workflow dispatch with $BUMP_TYPE bump"
        else
          # Check if we're on master or develop
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            BUMP_TYPE="minor"
            echo "On master branch - will bump minor version"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            BUMP_TYPE="patch"
            echo "On develop branch - will bump patch version"
          else
            echo "Not on master or develop - no version bump"
            echo "should-bump=false" >> $GITHUB_OUTPUT
            echo "chart-version=$CHART_VERSION" >> $GITHUB_OUTPUT
            echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
            echo "image-tag=$APP_VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if tag already exists for current version
          TAG_EXISTS=$(git tag -l "v$CHART_VERSION" | wc -l)
          if [ "$TAG_EXISTS" -gt 0 ] && [ "$FORCE_BUMP" != "true" ]; then
            echo "Tag v$CHART_VERSION already exists - no version bump needed"
            echo "should-bump=false" >> $GITHUB_OUTPUT
            echo "chart-version=$CHART_VERSION" >> $GITHUB_OUTPUT
            echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
            echo "image-tag=$APP_VERSION" >> $GITHUB_OUTPUT
            exit 0
          else
            SHOULD_BUMP="true"
            echo "Tag v$CHART_VERSION does not exist or force bump enabled - will bump $BUMP_TYPE"
          fi
        fi
        
        if [ "$SHOULD_BUMP" = "true" ]; then
          # Parse current version
          IFS='.' read -r major minor patch <<< "$CHART_VERSION"
          
          # Bump version based on type
          case "$BUMP_TYPE" in
            "patch")
              patch=$((patch + 1))
              ;;
            "minor")
              minor=$((minor + 1))
              patch=0
              ;;
            "major")
              major=$((major + 1))
              minor=0
              patch=0
              ;;
          esac
          
          NEW_CHART_VERSION="$major.$minor.$patch"
          NEW_APP_VERSION="v$NEW_CHART_VERSION"
          NEW_TAG="v$NEW_CHART_VERSION"
          
          echo "New chart version: $NEW_CHART_VERSION"
          echo "New app version: $NEW_APP_VERSION"
          echo "New tag: $NEW_TAG"
          
          # Update Chart.yaml
          sed -i "s/^version: .*/version: $NEW_CHART_VERSION/" charts/dbchan/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"$NEW_APP_VERSION\"/" charts/dbchan/Chart.yaml
          
          # Update values.yaml to use the new app version as image tag
          sed -i "s/^      tag: .*/      tag: \"$NEW_APP_VERSION\"/" charts/dbchan/values.yaml
          
          # Commit and push changes
          git add charts/dbchan/Chart.yaml charts/dbchan/values.yaml
          git commit -m "Bump version to $NEW_CHART_VERSION ($BUMP_TYPE)"
          git push origin ${{ github.ref_name }}
          
          # Create and push tag
          git tag $NEW_TAG
          git push origin $NEW_TAG
          
          echo "should-bump=true" >> $GITHUB_OUTPUT
          echo "chart-version=$NEW_CHART_VERSION" >> $GITHUB_OUTPUT
          echo "app-version=$NEW_APP_VERSION" >> $GITHUB_OUTPUT
          echo "image-tag=$NEW_APP_VERSION" >> $GITHUB_OUTPUT
          echo "new-tag=$NEW_TAG" >> $GITHUB_OUTPUT
        else
          echo "should-bump=false" >> $GITHUB_OUTPUT
          echo "chart-version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "image-tag=$APP_VERSION" >> $GITHUB_OUTPUT
        fi

  build-and-push:
    runs-on: ubuntu-latest
    needs: version-management
    if: needs.version-management.result == 'success' && (needs.version-management.outputs.should-bump == 'true' || github.event_name == 'push')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
    
    - name: Build project
      run: make build
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and Push Docker image
      run: make docker-buildx IMG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version-management.outputs.image-tag }}

  build-and-push-chart:
    runs-on: ubuntu-latest
    needs: [version-management, build-and-push]
    if: needs.version-management.result == 'success' && needs.build-and-push.result == 'success' && (needs.version-management.outputs.should-bump == 'true' || github.event_name == 'push')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'
    
    - name: Package Helm Chart
      run: |
        echo "Packaging chart with version: ${{ needs.version-management.outputs.chart-version }}"
        
        # Ensure Chart.yaml has the correct version (in case it wasn't updated in version-management)
        sed -i "s/^version: .*/version: ${{ needs.version-management.outputs.chart-version }}/" charts/dbchan/Chart.yaml
        sed -i "s/^appVersion: .*/appVersion: \"${{ needs.version-management.outputs.app-version }}\"/" charts/dbchan/Chart.yaml
        
        # Verify the version in Chart.yaml
        echo "Chart.yaml version: $(grep '^version:' charts/dbchan/Chart.yaml)"
        echo "Chart.yaml appVersion: $(grep '^appVersion:' charts/dbchan/Chart.yaml)"
        
        helm package charts/dbchan --destination ./dist/
        echo "Chart packaged successfully"
        echo "Available files in dist/:"
        ls -la ./dist/
        echo "Chart file should be: dbchan-${{ needs.version-management.outputs.chart-version }}.tgz"
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and Push Chart OCI Artifact
      run: |
        # Enable OCI support for Helm
        export HELM_EXPERIMENTAL_OCI=1
        
        # Login to Docker Hub registry
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | helm registry login registry-1.docker.io \
          --username ${{ secrets.DOCKERHUB_USERNAME }} \
          --password-stdin
        
        # Verify the chart file exists
        CHART_FILE="./dist/dbchan-${{ needs.version-management.outputs.chart-version }}.tgz"
        if [ ! -f "$CHART_FILE" ]; then
          echo "Error: Chart file $CHART_FILE not found!"
          echo "Available files in dist/:"
          ls -la ./dist/ || echo "dist/ directory not found"
          exit 1
        fi
        
        echo "Pushing chart file: $CHART_FILE"
        
        # Push chart to OCI registry
        helm push "$CHART_FILE" \
          oci://registry-1.docker.io/${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chart
        
        
        echo "Chart artifact pushed successfully to OCI registry"
    
  rollback:
    runs-on: ubuntu-latest
    needs: [version-management, build-and-push, build-and-push-chart]
    if: failure() && needs.version-management.outputs.should-bump == 'true'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Rollback Version Changes
      run: |
        echo "ðŸ”„ Rolling back version changes due to workflow failure..."
        
        # Pull latest changes to ensure we're up to date
        git pull origin ${{ github.ref_name }} || echo "Failed to pull, continuing with rollback"
        
        # Get the original versions (before bump)
        ORIGINAL_CHART_VERSION="${{ needs.version-management.outputs.chart-version }}"
        ORIGINAL_APP_VERSION="${{ needs.version-management.outputs.app-version }}"
        
        # If version was bumped, we need to revert to previous version
        if [ "${{ needs.version-management.outputs.should-bump }}" = "true" ]; then
          # Parse current version to get previous version
          IFS='.' read -r major minor patch <<< "$ORIGINAL_CHART_VERSION"
          
          # Calculate previous version based on bump type
          BUMP_TYPE="${{ github.event.inputs.version_bump_type || 'minor' }}"
          case "$BUMP_TYPE" in
            "patch")
              if [ "$patch" -gt 0 ]; then
                patch=$((patch - 1))
              fi
              ;;
            "minor")
              if [ "$minor" -gt 0 ]; then
                minor=$((minor - 1))
                patch=0
              fi
              ;;
            "major")
              if [ "$major" -gt 0 ]; then
                major=$((major - 1))
                minor=0
                patch=0
              fi
              ;;
          esac
          
          PREVIOUS_CHART_VERSION="$major.$minor.$patch"
          PREVIOUS_APP_VERSION="v$PREVIOUS_CHART_VERSION"
          
          echo "Reverting from $ORIGINAL_CHART_VERSION to $PREVIOUS_CHART_VERSION"
          
          # Revert Chart.yaml
          sed -i "s/^version: .*/version: $PREVIOUS_CHART_VERSION/" charts/dbchan/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"$PREVIOUS_APP_VERSION\"/" charts/dbchan/Chart.yaml
          
          # Revert values.yaml
          sed -i "s/^      tag: .*/      tag: \"$PREVIOUS_APP_VERSION\"/" charts/dbchan/values.yaml
          
          # Check if there are any changes to commit
          if git diff --quiet charts/dbchan/Chart.yaml charts/dbchan/values.yaml; then
            echo "No changes detected in Chart.yaml or values.yaml - they may already be at the correct version"
          else
            echo "Changes detected, committing rollback..."
            git add charts/dbchan/Chart.yaml charts/dbchan/values.yaml
            git commit -m "Rollback version to $PREVIOUS_CHART_VERSION due to workflow failure"
            
            # Force push if necessary (since we're rolling back)
            git push origin ${{ github.ref_name }} --force-with-lease || {
              echo "Failed to push rollback with --force-with-lease, trying regular push..."
              git push origin ${{ github.ref_name }} --force || echo "Failed to push rollback"
            }
          fi
          
          # Delete the tag if it was created
          if [ -n "${{ needs.version-management.outputs.new-tag }}" ]; then
            echo "Attempting to delete tag ${{ needs.version-management.outputs.new-tag }}"
            
            # Delete local tag
            git tag -d "${{ needs.version-management.outputs.new-tag }}" 2>/dev/null || echo "Local tag not found or already deleted"
            
            # Delete remote tag
            git push origin --delete "${{ needs.version-management.outputs.new-tag }}" 2>/dev/null || echo "Remote tag not found or already deleted"
          else
            echo "No tag to delete"
          fi
          
          echo "âœ… Rollback completed successfully"
        else
          echo "â„¹ï¸ No version bump was performed, no rollback needed"
        fi
    
    - name: Rollback Summary
      run: |
        echo "## ðŸ”„ Rollback Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âŒ Workflow Failure" >> $GITHUB_STEP_SUMMARY
        echo "The CI/CD pipeline failed and rollback has been initiated." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Actions Taken" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.version-management.outputs.should-bump }}" = "true" ]; then
          echo "- âœ… Reverted Chart.yaml to previous version" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Reverted values.yaml to previous version" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deleted Git tag ${{ needs.version-management.outputs.new-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pushed rollback changes to repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â„¹ï¸ No version bump was performed, no rollback needed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Failed Jobs" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version Management | ${{ needs.version-management.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Push Image | ${{ needs.build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Push Chart | ${{ needs.build-and-push-chart.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” Review the failed job logs to identify the issue" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”§ Fix the issue and re-run the workflow" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ Check that all changes have been properly reverted" >> $GITHUB_STEP_SUMMARY

  summary:
    runs-on: ubuntu-latest
    needs: [version-management, build-and-push, build-and-push-chart, rollback]
    if: always()
    
    steps:
    - name: Workflow Summary
      run: |
        echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Version Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Chart Version**: ${{ needs.version-management.outputs.chart-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **App Version**: ${{ needs.version-management.outputs.app-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: ${{ needs.version-management.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version Bumped**: ${{ needs.version-management.outputs.should-bump }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.version-management.outputs.new-tag }}" != "" ]; then
          echo "- **New Git Tag**: ${{ needs.version-management.outputs.new-tag }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
        echo "- **Controller Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version-management.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“¦ Helm Charts" >> $GITHUB_STEP_SUMMARY
        echo "- **Chart Package**: \`dbchan-${{ needs.version-management.outputs.chart-version }}.tgz\`" >> $GITHUB_STEP_SUMMARY
        echo "- **OCI Registry**: \`oci://registry-1.docker.io/${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chart\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Chart Version**: \`${{ needs.version-management.outputs.chart-version }}\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.version-management.outputs.should-bump }}" = "true" ]; then
          echo "- **Latest Tag**: \`latest\`" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”§ Installation Commands" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Install from OCI registry" >> $GITHUB_STEP_SUMMARY
        echo "helm install dbchan oci://registry-1.docker.io/${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chart --version ${{ needs.version-management.outputs.chart-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Or install latest version" >> $GITHUB_STEP_SUMMARY
        echo "helm install dbchan oci://registry-1.docker.io/${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chart" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‹ Job Status" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version Management | ${{ needs.version-management.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Push Image | ${{ needs.build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Push Chart | ${{ needs.build-and-push-chart.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Rollback | ${{ needs.rollback.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.rollback.result }}" = "success" ]; then
          echo "- ðŸ”„ **ROLLBACK COMPLETED** - Version changes have been reverted" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Review the failed job logs to identify the issue" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Fix the issue and re-run the workflow" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Verify that all changes have been properly reverted" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.version-management.outputs.should-bump }}" = "true" ]; then
          echo "- âœ… New version ${{ needs.version-management.outputs.chart-version }} has been released" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker image and Helm chart are available" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git tag ${{ needs.version-management.outputs.new-tag }} has been created" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“– Check the artifacts section for downloadable chart packages" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â„¹ï¸ No version bump was performed" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸ Using existing version ${{ needs.version-management.outputs.chart-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“– Check the artifacts section for downloadable chart packages" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- ðŸ” Review the logs for any warnings or issues" >> $GITHUB_STEP_SUMMARY

